<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  
    


<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>




  <meta name="keywords" content="Hexo,next" />



  <link rel="alternate" href="/atom.xml" title="Dev Note" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta property="og:type" content="website">
<meta property="og:title" content="Dev Note">
<meta property="og:url" content="http://note.49px.com/page/3/index.html">
<meta property="og:site_name" content="Dev Note">
<meta property="article:author" content="Yang Le">
<meta name="twitter:card" content="summary">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> Dev Note </title>
<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode" target="_blank" rel="noopener">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">Dev Note</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 
  <section id="posts" class="posts-expand">
    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/core-animation/" itemprop="url">
                Core Animation 笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2014-12-05T00:00:00+08:00" content="2014-12-05">
            2014-12-05
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/core-animation/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="core-animation/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>Core Animation把view内容存成bitmap传给GPU，通过尽量使用缓存的bitmap，并修改传入GPU的bounds/position/transform/alpha等属性来画图。这就比view的drawRect:高效得多，drawRect:要占用CPU的主线程来画图。</p>
<p>animation状态由layer trees表示，layer tree与view tree层次结构相同：</p>
<ul>
<li>model layer tree：存着animation的target values</li>
<li>presentation tree: 存着animation的in-flight values</li>
<li>render tree: 管着实际animation，Core Animation私有</li>
</ul>
<p>presentationLayer当图层第一次在屏幕显示时创建，在此之前是nil</p>
<p>要修改view的底层layer，可重载<code>+ (Class)layerClass;</code></p>
<p>UIView封装了CALayer，添加了布局和事件处理功能，但有些CALayer的功能没有暴露出来：</p>
<ul>
<li>阴影、圆角、带颜色的边框</li>
<li>3D变换</li>
<li>非矩形区域</li>
<li>图层蒙版</li>
<li>多级非线性动画</li>
</ul>
<p>给layer.contents赋值：<code>layer.contents = (__bridge id)image.CGImage;</code></p>
<p>给layer.mask设置一个mask图层，对应mask图层<code>opacity == 1</code>的部分会被保留下来，其他部分根据opacity变得透明</p>
<p>view的masksToBounds会把超出边界的阴影切掉。为有阴影，可以在外面套一层view，内层view使用mask，外层view使用阴影。</p>
<p>view.transform是<code>CGAffineTransform</code>类型（对应layer.affineTransform），在二维平面的旋转、缩放、平移、切变都是仿射变换（即在变换后平行线仍平行）</p>
<p>通过设置layer.sublayerTransform（<code>CATransform3D</code>类型）的<code>m34</code>元素为<code>-1.0/d</code>可对子图层应用透视效果。<code>d</code>代表想象中视角相机和屏幕的距离，以像素为单位，通常500~1000就好。这样，sublayer.transform（<code>CATransform3D</code>类型）就只要CATransform3DMakeRotation即可，不用再设置<code>m34</code>透视。</p>
<p>在animation时设置<code>transform.rotation</code>、<code>transform.scale</code>等虚拟属性，Core Animation会自动根据<code>CAValueFunction</code>计算的值来更新<code>transform</code>属性</p>
<p><code>duration</code>是动画一次迭代的时间；若配合迭代次数<code>repeatCount</code>，则动画总时间是<code>duration * repeatCount</code>；若配合动画总时间<code>repeatDuration</code>，则迭代次数是<code>repeatDuration / duration</code></p>
<p>即使你不显式地用<code>[CATransaction begin]</code>开始一次事务，任何一次runloop循环中属性的改变都会被集中到一个新的<code>CATransaction</code>，然后做一次默认0.25秒的动画。</p>
<p>按Home键退出app时，系统会在layer上调<code>removeAllAnimations</code></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreAnimation_guide/Introduction/Introduction.html" target="_blank" rel="noopener">Core Animation Programming Guide</a></li>
<li><a href="https://github.com/AttackOnDobby/iOS-Core-Animation-Advanced-Techniques" target="_blank" rel="noopener">iOS Core Animation Advanced Techniques</a></li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/mvvm/" itemprop="url">
                MVVM笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2014-11-29T00:00:00+08:00" content="2014-11-29">
            2014-11-29
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/mvvm/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="mvvm/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>经典的MVC (Model-View-Controller) 里Model负责数据，View负责界面，Controller负责两者之间的交互。但仔细想想，View和Controller虽然是不同的组件，却几乎总是一对一配套使用。在MVVM (Model-View-ViewModel) 中，就把MVC的View和Controller概念合并成一个View/Controller，然后Model-View间多加一层ViewModel。</p>
<p><img src="/images/mvvm.png" alt=""></p>
<p>在ViewModel可以将Model数据转换为View呈现所需数据（如将NSDate格式化成字符串），可以保存View状态，可以做用户输入的验证，可以发收网络请求等。</p>
<p>ViewModel的属性变化通过KVO (Key-Value Observing) 通知Controller，可用facebook的<code>KVOController</code>库。</p>
<p>ps: <code>[photosArray addObjectsFromArray:photos]</code>不会发KVO通知，要用<code>[[self mutableArrayValueForKeyPath:@&quot;photosArray&quot;] addObjectsFromArray:photos];</code>。</p>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><ul>
<li><a href="http://www.objc.io/issue-13/mvvm.html" target="_blank" rel="noopener">Introduction to MVVM</a></li>
<li><a href="https://medium.com/@ramshandilya/lets-discuss-mvvm-for-ios-a7960c2f04c7" target="_blank" rel="noopener">Let’s discuss MVVM for iOS</a></li>
<li><a href="http://limboy.me/ios/2015/09/27/ios-mvvm-without-reactivecocoa.html" target="_blank" rel="noopener">MVVM without ReactiveCocoa</a></li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/touch/" itemprop="url">
                Touch Handling 笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2014-11-24T00:00:00+08:00" content="2014-11-24">
            2014-11-24
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/touch/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="touch/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>touch handling时先<code>hitTest:withEvent:</code>找出hitView：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UIView</span> *)hitTest:withEvent: &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="comment">/* pointInside:withEvent:, eg. point is in our bounds */</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="comment">/* each subview, in reverse order (eg. from top to bottom) */</span> &#123;</span><br><span class="line">            hitView = <span class="comment">/* recursive call hitTest:withEvent: on subview */</span></span><br><span class="line">            <span class="keyword">if</span> (hitView != <span class="literal">nil</span>) <span class="keyword">return</span> hitView;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Responder-Chain"><a href="#Responder-Chain" class="headerlink" title="Responder Chain"></a>Responder Chain</h4><p>然后UIWindow就<code>sendEvent:</code>给这个view。hitView遵循responderChain：</p>
<ul>
<li>若hitView实现了<code>touchesBegan:</code>，不管有没实现其他3个方法：调hitView的<code>touchesBegan:</code>方法，再调hitView的其他3个方法（如果实现了的话）</li>
<li>若hitView没实现<code>touchesBegan:</code>，但实现了其他3个方法：沿chain找到第一个响应<code>touchesBegan:</code>的ancestorView，其他3个方法在沿着chain从<code>[hitView -&gt; ancestorView]</code>的各个view上依次调用。</li>
</ul>
<p>responderChain基本就是沿着superview转发touch。如果这个superview是viewController.view，那实际上是将touch交给viewController处理。例如，parentView -&gt; parent’s viewController -&gt; window -&gt; application -&gt; applicationDelegate。</p>
<p>但我们不能手动将touch传给nextResponder（下面的写法不太work）：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">touchesBegan</span><span class="selector-pseudo">:(NSSet</span> *)<span class="selector-tag">touches</span> <span class="selector-tag">withEvent</span><span class="selector-pseudo">:(UIEvent</span> *)<span class="selector-tag">event</span> &#123;</span><br><span class="line">    <span class="selector-attr">[[self nextResponder]</span> <span class="selector-tag">touchesBegan</span><span class="selector-pseudo">:touches</span> <span class="selector-tag">withEvent</span><span class="selector-pseudo">:event</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Gesture-Recognizer"><a href="#Gesture-Recognizer" class="headerlink" title="Gesture Recognizer"></a>Gesture Recognizer</h4><p>gestureRecognizer不依赖responderChain。从<code>[hitView -&gt; window]</code>链上的所有gestureRecognizers都可以处理touch。<code>touchesBegan:</code>和<code>touchesMoved:</code>会同时发给hitView和<code>[hitView -&gt; window]</code>链上的所有gestureRecognizers。在touchesEnded阶段，如果沿链有gestureRecognizer识别成功就给hitView发<code>touchesCancelled:</code>（默认<code>gestureRecognizer.cancelsTouchesInView == YES</code>），如果识别失败就给hitView发<code>touchesEnded:withEvent:</code>。</p>
<p>gestureRecognizer默认不能与其他gestureRecognizers同时识别成功，可以重载delegate方法：<code>gestureRecognizer:shouldRecognizeSimultaneouslyWithGestureRecognizer:</code></p>
<p>gestureRecognizer的默认属性：</p>
<ul>
<li>cancelsTouchesInView (default YES)，识别成功时向touch.view发<code>touchesCancelled:</code></li>
<li>delaysTouchesBegan (default NO)，<code>touchesBegan:</code>会同时发往touch.view，若设为YES则得等自己识别失败才把<code>touchesBegan:</code>发往touch.view</li>
<li>delaysTouchesEnded (default YES)，例如，这样就不会把双击识别成两次单击</li>
</ul>
<h4 id="UIScrollView"><a href="#UIScrollView" class="headerlink" title="UIScrollView"></a>UIScrollView</h4><p>scrollView不管有没实现<code>touchesBegan:</code>等4个方法，都会自己处理touch不会向responderChain转发。这很可能是因为scrollView默认实现了<code>touchesBegan:</code>方法。</p>
<p>webView即使实现了<code>touchesBegan:</code>等4个方法也不会调用到，touch都被隐藏嵌套的<code>_UIWebViewScrollView</code>（<em>: UIWebScrollView : UIScrollView*）吞掉了，交给干活的子view，如<code>UIWebBrowserView</code>（</em>: UIWebDocumentView : UIWebTiledView : UIView*）处理。由于webView内部scrollView会吞掉touch，甚至在touchMoved几次后把touch.view变成nil。要对将传给webView的touch做其他处理，可重载UIWindow的<code>sendEvent:</code>，先截获感兴趣的touch做处理，再<code>[super sendEvent:event];</code>走正常流程将touch传给webView。</p>
<p>默认<code>scrollView.delaysContentTouches == YES</code>，即scrollView有个内装定时器的gestureRecognizer，设置有<code>gestureRecognizer.delaysTouchesBegan = YES</code>，要等这小定时器超时gestureRecognizer识别失败才给view转发touchesBegan:消息。当快速滚动scrollView时，panGestureRecognizer立即识别成功，识别成功的gestureRecognizer默认cancelsTouchesInView。由于touchesBegan:消息还没发出，不再发送touchesCancelled:，直接把touchesBegan:消息丢掉。</p>
<h4 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h4><p>若target小于<code>44pt</code>不好点中，应重载target的<code>pointInside:withEvent:</code>来扩展可点击区域<code>CGRectInset(self.bounds, -expansion, -expansion)</code></p>
<hr>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><ul>
<li><a href="https://developer.apple.com/library/ios/documentation/EventHandling/Conceptual/EventHandlingiPhoneOS/Introduction/Introduction.html" target="_blank" rel="noopener">Event Handling Guide for iOS</a></li>
<li>Advanced ScrollViews and Touch Handling Techniques, WWDC2014#235</li>
<li>Enhancing User Experience with Scroll Views, WWDC2012#223</li>
<li><a href="http://psvsps2.blogspot.jp/2010/05/iphone-multi-touch-event-handling.html" target="_blank" rel="noopener">iPhone Multi-touch Event Handling</a></li>
<li><a href="http://labs.freescapes.org/blog/main/swiping-and-pinching-with-uiwebview/" target="_blank" rel="noopener">swiping and pinching with UIWebView</a></li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/wwdc/" itemprop="url">
                WWDC Demo 备忘
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2014-11-20T00:00:00+08:00" content="2014-11-20">
            2014-11-20
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/wwdc/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="wwdc/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h4 id="wwdc2014-226"><a href="#wwdc2014-226" class="headerlink" title="wwdc2014#226"></a>wwdc2014#226</h4><ul>
<li>self-sizing cell for tableView/collectionView</li>
</ul>
<h4 id="wwdc2014-232"><a href="#wwdc2014-232" class="headerlink" title="wwdc2014#232"></a>wwdc2014#232</h4><ul>
<li>Aggregate Data Source</li>
<li>对loading content过程引入state machine</li>
</ul>
<h4 id="wwdc2014-235"><a href="#wwdc2014-235" class="headerlink" title="wwdc2014#235"></a>wwdc2014#235</h4><ul>
<li>用scrollView实现：下拉出现的view</li>
<li>实现：在不同view间拖放对象</li>
</ul>
<h4 id="wwdc2014-236"><a href="#wwdc2014-236" class="headerlink" title="wwdc2014#236"></a>wwdc2014#236</h4><ul>
<li>Presentation Layer Hit Test</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">override func hit<span class="constructor">Test(<span class="params">point</span>: CGPoint, <span class="params">withEvent</span> <span class="params">event</span>: UIEvent!)</span> -&gt; UIView! &#123;</span><br><span class="line">    <span class="keyword">let</span> superviewPoint = convert<span class="constructor">Point(<span class="params">point</span>, <span class="params">toView</span>:<span class="params">superview</span>)</span></span><br><span class="line">    <span class="keyword">let</span> point = layer.presentationLayer.convert<span class="constructor">Point(<span class="params">superviewPoint</span>, <span class="params">fromLayer</span>:<span class="params">superview</span>.<span class="params">layer</span>)</span></span><br><span class="line">    return super.hit<span class="constructor">Test(<span class="params">point</span>, <span class="params">withEvent</span>:<span class="params">event</span>)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="wwdc2013-217"><a href="#wwdc2013-217" class="headerlink" title="wwdc2013#217"></a>wwdc2013#217</h4><ul>
<li><p>实现：内嵌的小scrollView拖动距离超过distance后拖动外部的大scrollView，像iOS锁屏时拖动通知条项反而拖过来九宫密码页</p>
<p>  内嵌scrollView的宽要设为<code>2 * (pageWidth + distance)</code>。若设为 2 * pageWidth，由于被distance占用了一段拖动距离，当内嵌scrollView拖到头时没法把外部scrollView全拖过来。</p>
<p>  设置外部scrollView的contentOffset.x时，内嵌scrollView因为是它的子view也会移动，这样就导致移动距离加倍，需要反方向translate回去</p>
</li>
<li><p>实现：在拖动放手后，内外两个scrollView以不同速率回到同一点</p>
<p>  在内嵌scrollView的<code>scrollViewDidScroll:</code>里按速率比调节外部scrollView的contentOffset.x</p>
</li>
<li><p>实现：快速滑动浏览列表项时的弹簧效果：</p>
<p>  UIDynamic可方便配合UICollectionViewFlowLayout子类</p>
</li>
</ul>
<h4 id="wwdc2012-223"><a href="#wwdc2012-223" class="headerlink" title="wwdc2012#223"></a>wwdc2012#223</h4><ul>
<li>用UIPageViewController实现photo browsing</li>
</ul>
<h4 id="wwdc2012-228"><a href="#wwdc2012-228" class="headerlink" title="wwdc2012#228"></a>wwdc2012#228</h4><ul>
<li>讲AutoLayout怎么debug</li>
</ul>
<h4 id="wwdc2012-232"><a href="#wwdc2012-232" class="headerlink" title="wwdc2012#232"></a>wwdc2012#232</h4><ul>
<li>用Instruments调试AutoLayout错误</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><h4 id="UIScrollView"><a href="#UIScrollView" class="headerlink" title="UIScrollView"></a>UIScrollView</h4><ul>
<li>2009 - Mastering iPhone Scroll Views: basic</li>
<li>2010 - Designing Apps with Scroll Views: photo browsing, tiling</li>
<li>2011 - Advanced Scroll View Techniques: infinite scrolling, stationary views, interaction with gestures</li>
<li>2012#223 - Enhancing User Experience with Scroll Views: photo browsing 2.0, scrolling with OpenGL, custom deceleration</li>
<li>2013#217 - Exploring Scroll Views in iOS 7: nested scroll views, integration with dynamics</li>
<li>2014#235 - Advanced ScrollViews and Touch Handling Techniques</li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/autolayout/" itemprop="url">
                AutoLayout笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2014-11-16T00:00:00+08:00" content="2014-11-16">
            2014-11-16
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/autolayout/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="autolayout/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h3 id="AutoLayout"><a href="#AutoLayout" class="headerlink" title="AutoLayout"></a>AutoLayout</h3><p>AutoLayout基于描述性的constraints：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">item1.attribute1 </span>= <span class="keyword">multipler </span>x <span class="keyword">item2.attribute2 </span>+ constant</span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">id</span>)constraintWithItem:(<span class="keyword">id</span>)item1</span><br><span class="line">               attribute:(<span class="built_in">NSLayoutAttribute</span>)attribute1</span><br><span class="line">               relatedBy:(<span class="built_in">NSLayoutAttribute</span>)relation</span><br><span class="line">                  toItem:(<span class="keyword">id</span>)item2</span><br><span class="line">               attribute:(<span class="built_in">NSLayoutAttribute</span>)attribute2</span><br><span class="line">              multiplier:(<span class="built_in">CGFloat</span>)multiplier</span><br><span class="line">                constant:(<span class="built_in">CGFloat</span>)constant;</span><br></pre></td></tr></table></figure>

<p>要将constraint加到item1和item2的最近公共祖先 (Least Common Ancestor) 中：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(void)</span>addConstraint:<span class="params">(NSLayoutConstraint *)</span>constraint;</span><br></pre></td></tr></table></figure>

<p>AutoLayout先自底向上updateConstraints，再自顶向下layoutSubviews。layoutSubviews时调view的<code>setCenter:</code>和<code>setBounds:</code></p>
<p>constraint的priority默认1000（required constraint），当priority&lt;1000时表示optional constraint，数值越高优先级越高。</p>
<p>Intrinsic Content Size &amp; Compression Resistance &amp; Content Hugging：<br><img src="/images/intrinsic-content-size.png" alt=""></p>
<h4 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h4><ul>
<li>ambigulous: multiple layouts satisfy all constraints equally well</li>
<li>unsatisfiability: no layout can satisfy all <strong>required</strong> constraints</li>
</ul>
<p>查看autolayout情况：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) <span class="keyword">po</span> [<span class="keyword">view</span> _autolayoutTrace]</span><br></pre></td></tr></table></figure>
<p>是否ambigulous：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[view hasAmbiguousLayout]</span><br></pre></td></tr></table></figure>
<p>换成ambigulous的另一个layout：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[view exerciseAmbiguityInLayout]</span><br></pre></td></tr></table></figure>
<p>显示紫色半透明的布局错误提示层：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[window visualizeConstraints:@[]]</span><br></pre></td></tr></table></figure>
<p>可设置NSUserDefaults的<code>NSConstraintBasedLayoutVisualizeMutallyExclusiveConstraint</code>为YES，则当布局出错时自动调用<code>[window visualizeConstraints:]</code></p>
<p>什么constraints导致view的当前大小：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[view constraintsAffectingLayoutForAxis:NSLayoutConstraintOrientationHorizontal/Vertical]</span><br></pre></td></tr></table></figure>
<p>转换自autoresizing mask的constraints：<code>h=-&amp;- v=&amp;--</code>：<code>h=</code>/<code>v=</code>分别表示horizontal/vertical方向，<code>-</code>表示fixed size，<code>&amp;</code>表示flexible size，3个符号依次表示margin, dimension, margin</p>
<hr>
<h3 id="Size-Classes"><a href="#Size-Classes" class="headerlink" title="Size Classes"></a>Size Classes</h3><p>iOS 8起，为替代<code>UIInterfaceOrientation</code>和<code>UIUserInterfaceIdiom</code>引入了<code>Size Classes</code></p>
<p>参见：<a href="https://developer.apple.com/library/ios/releasenotes/General/WhatsNewIniOS/Articles/iOS8.html#//apple_ref/doc/uid/TP40014205-SW30" target="_blank" rel="noopener">Traits Describe the Size Class and Scale of an Interface</a></p>
<p>There are two types of size classes in iOS 8: regular and compact. A regular size class denotes either a large amount of screen space, such as on an iPad, or a commonly adopted paradigm that provides the illusion of a large amount of screen space, such as scrolling on an iPhone.</p>
<p>With the amount of screen space available, the iPad has a regular size class in the vertical and horizontal directions in both portrait and landscape orientations.</p>
<p>The size classes for iPhones differ based on the kind of device and its orientation. In portrait, the screen has a compact size class horizontally and a regular size class vertically. This corresponds to the common usage paradigm of scrolling vertically for more information. When iPhones are in landscape, their size classes vary. Most iPhones have a compact size class both horizontally and vertically</p>
<h4 id="default-size-classes"><a href="#default-size-classes" class="headerlink" title="default size classes"></a>default size classes</h4><ul>
<li>iPad landscape&amp;portait: V Regular | H Regular</li>
<li>iPhone portait: V Regular | H Compact</li>
<li>iPhone landscape: V Compact | H Compact</li>
</ul>
<h3 id="Traits"><a href="#Traits" class="headerlink" title="Traits"></a>Traits</h3><p>布局相关的属性，如 horizontalSizeClass / verticalSizeClass / userInterfaceIdiom / displayScale，都集中在对象的traitCollection中。</p>
<p>支持布局的对象，如 UIScreen / UIWindow / UIViewController / UIView / UIPresentationController，都实现了UITraitEnvironment协议，可以返回当前的traitCollection。UIViewController / UIView 也可以重载<code>traitCollectionDidChange:</code>来监听traitCollection的改变。</p>
<p>traitCollection中未指定的trait就是Unspecified的。若traiCollection A中所有已指定的trait都与traitCollection B中的相等，则说A包含于B。两个traitCollection还能合并，X和Unspecified合并成X，值有冲突的（如Compact和Regular）保留合并进来的那个值。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li>Introduction to AutoLayout for iOS and OS X, WWDC2012#202</li>
<li>Best Practices for Mastering Auto Layout, WWDC2012#228</li>
<li>Auto Layout by Example, WWDC2012#232</li>
<li><a href="https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/AutolayoutPG/VisualFormatLanguage/VisualFormatLanguage.html" target="_blank" rel="noopener">Visual Format Language</a></li>
<li>Building Adaptive Apps with UIKit, WWDC2014#216</li>
<li>为iPhone6设计自适应布局：<a href="http://www.devtalking.com/articles/adaptive-layout-for-iphone6-1/" target="_blank" rel="noopener">AutoLayout</a>、<a href="http://www.devtalking.com/articles/adaptive-layout-for-iphone6-2/" target="_blank" rel="noopener">SizeClasses</a></li>
<li><a href="http://www.objc.io/issue-3/advanced-auto-layout-toolbox.html" target="_blank" rel="noopener">Advanced Auto Layout Toolbox</a></li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/objc-runtime/" itemprop="url">
                ObjectiveC Runtime 笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2014-11-13T00:00:00+08:00" content="2014-11-13">
            2014-11-13
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/objc-runtime/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="objc-runtime/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">import</span> <span class="string">"objc/runtime.h"</span></span><br></pre></td></tr></table></figure>
<h3 id="Runtime术语"><a href="#Runtime术语" class="headerlink" title="Runtime术语"></a>Runtime术语</h3><p><code>objc_msgSend</code>的方法定义：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id objc<span class="constructor">_msgSend(<span class="params">id</span> <span class="params">self</span>, SEL <span class="params">op</span>, <span class="operator">...</span>)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_selector</span> *<span class="title">SEL</span>;</span></span><br></pre></td></tr></table></figure>
<p>SEL即selector，本质是<em>方法名的常量字符串</em>，所以同名方法就是同一个selector</p>
<h4 id="id"><a href="#id" class="headerlink" title="id"></a>id</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> *<span class="title">id</span>;</span></span><br></pre></td></tr></table></figure>
<p>而objc_object为:</p>
<figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> </span>&#123; Class isa; &#125;;</span><br></pre></td></tr></table></figure>
<h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> *<span class="title">Class</span>;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> &#123;</span></span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !__OBJC2__</span></span><br><span class="line">    Class super_class                                        OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name                                         OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar_list</span> *<span class="title">ivars</span>                             <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_method_list</span> **<span class="title">methodLists</span>                    <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> *<span class="title">cache</span>                                 <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_protocol_list</span> *<span class="title">protocols</span>                     <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar_list</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> ivar_count                                           OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar</span> <span class="title">ivar_list</span>[1]                            <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line">&#125;     </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_method_list</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_method_list</span> *<span class="title">obsolete</span>                        <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> method_count                                         OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_method</span> <span class="title">method_list</span>[1]                        <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Ivar"><a href="#Ivar" class="headerlink" title="Ivar"></a>Ivar</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar</span> *<span class="title">Ivar</span>;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *ivar_name                                          OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">char</span> *ivar_type                                          OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">int</span> ivar_offset                                          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h4><p>Method代表类中某个方法：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_method *<span class="function"><span class="keyword">Method</span>;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">struct</span> objc_method &#123;</span><br><span class="line">    <span class="attribute">SEL</span> method_name                                          OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="attribute">char</span> *method_types                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="attribute">IMP</span> method_imp                                           OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>方法名SEL本质是个常量字符串</li>
<li>方法类型是个char指针，存储着方法的参数和返回值类型编码</li>
<li>方法实现IMP是个函数指针</li>
</ul>
<h4 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h4><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef id (*<span class="type">IMP</span>)(id, <span class="type">SEL</span>, ...);</span><br></pre></td></tr></table></figure>
<p>该函数指针指向的方法与<code>objc_msgSend</code>函数类型相同</p>
<h4 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> *<span class="title">Cache</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mask <span class="comment">/* total = mask + 1 */</span>                 OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> occupied                                    OBJC2_UNAVAILABLE;</span><br><span class="line">    Method buckets[<span class="number">1</span>]                                        OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Runtime会把被调用的方法存到Cache中，为方法调用进行性能优化。当实例对象接收到一个消息时先在Cache中查找，若未命中再去isa指向的类的方法列表中遍历查找。</p>
<h4 id="Property"><a href="#Property" class="headerlink" title="Property"></a>Property</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_property</span> *<span class="title">Property</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_property</span> *<span class="title">objc_property_t</span>;</span> <span class="comment">//这个更常用</span></span><br></pre></td></tr></table></figure>
<p>可以通过<code>class_copyPropertyList</code>和<code>protocol_copyPropertyList</code>方法来获取类和协议中的属性，返回类型是指向objc_property_t数组的指针：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objc_property_t *<span class="keyword">class</span><span class="constructor">_copyPropertyList(Class <span class="params">cls</span>, <span class="params">unsigned</span> <span class="params">int</span> <span class="operator">*</span><span class="params">outCount</span>)</span></span><br><span class="line">objc_property_t *protocol<span class="constructor">_copyPropertyList(Protocol <span class="operator">*</span><span class="params">proto</span>, <span class="params">unsigned</span> <span class="params">int</span> <span class="operator">*</span><span class="params">outCount</span>)</span></span><br></pre></td></tr></table></figure>
<p>可以用<code>property_getName</code>函数来查找属性名称：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const <span class="built_in">char</span> *property<span class="constructor">_getName(<span class="params">objc_property_t</span> <span class="params">property</span>)</span></span><br></pre></td></tr></table></figure>
<p>可以用<code>class_getProperty</code>和<code>protocol_getProperty</code>通过给出的名称来在类和协议中获取属性的引用：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objc_property_t <span class="keyword">class</span><span class="constructor">_getProperty(Class <span class="params">cls</span>, <span class="params">const</span> <span class="params">char</span> <span class="operator">*</span><span class="params">name</span>)</span></span><br><span class="line">objc_property_t protocol<span class="constructor">_getProperty(Protocol <span class="operator">*</span><span class="params">proto</span>, <span class="params">const</span> <span class="params">char</span> <span class="operator">*</span><span class="params">name</span>, BOOL <span class="params">isRequiredProperty</span>, BOOL <span class="params">isInstanceProperty</span>)</span></span><br></pre></td></tr></table></figure>
<p>可以用<code>property_getAttributes</code>函数来获得属性的名称和@encode类型字符串：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const <span class="built_in">char</span> *property<span class="constructor">_getAttributes(<span class="params">objc_property_t</span> <span class="params">property</span>)</span></span><br></pre></td></tr></table></figure>
<p>把上面的代码放一起，就能从一个类中获取它的属性：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">id LenderClass = objc<span class="constructor">_getClass(<span class="string">"Lender"</span>)</span>;</span><br><span class="line">unsigned <span class="built_in">int</span> outCount, i;</span><br><span class="line">objc_property_t *properties = <span class="keyword">class</span><span class="constructor">_copyPropertyList(LenderClass, &amp;<span class="params">outCount</span>)</span>;</span><br><span class="line">for (i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">    objc_property_t property = properties<span class="literal">[<span class="identifier">i</span>]</span>;</span><br><span class="line">    fprintf(stdout, <span class="string">"%s %s\n"</span>, property<span class="constructor">_getName(<span class="params">property</span>)</span>, property<span class="constructor">_getAttributes(<span class="params">property</span>)</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="消息传递"><a href="#消息传递" class="headerlink" title="消息传递"></a>消息传递</h3><h4 id="objc-msgSend的流程"><a href="#objc-msgSend的流程" class="headerlink" title="objc_msgSend的流程"></a>objc_msgSend的流程</h4><ol>
<li>检测selector可不可以忽略，比如Mac开发中开启GC就会忽略retain/release调用</li>
<li>检测target是不是nil，ObjC的会忽略向nil发的消息</li>
<li>在target的Class中根据selector查找IMP<ol>
<li>先从cache里面找，找得到就跳到对应的函数去执行</li>
<li>cache里找不到就去找Class的方法列表</li>
<li>还找不到，就沿着继承链找超类的方法列表，直到NSObject类为止</li>
<li>实在找不到，进入动态方法解析和消息转发机制</li>
</ol>
</li>
</ol>
<h4 id="方法的隐藏参数"><a href="#方法的隐藏参数" class="headerlink" title="方法的隐藏参数"></a>方法的隐藏参数</h4><p>每个方法都有两个隐藏参数：<code>self</code>为接收者对象，<code>_cmd</code>为方法本身的selector</p>
<h4 id="获取方法地址"><a href="#获取方法地址" class="headerlink" title="获取方法地址"></a>获取方法地址</h4><p>NSObject中有个methodForSelector:实例方法，可以用来获取selector对应的IMP：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (*<span class="keyword">setter</span>)(<span class="keyword">id</span>, SEL, <span class="built_in">BOOL</span>);</span><br><span class="line"><span class="keyword">setter</span> = (<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="built_in">BOOL</span>))[target methodForSelector:<span class="keyword">@selector</span>(setFilled:)];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) <span class="keyword">setter</span>(targetList[i], <span class="keyword">@selector</span>(setFilled:), <span class="literal">YES</span>);</span><br></pre></td></tr></table></figure>
<p>这种做法很少用，除非需要持续大量重复调用某方法，才节省些消息传递开销</p>
<h4 id="动态方法解析"><a href="#动态方法解析" class="headerlink" title="动态方法解析"></a>动态方法解析</h4><p>用<code>@dynamic</code>修饰属性：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@dynamic</span> propertyName;</span><br></pre></td></tr></table></figure>
<p>编译器不会为我们生成setPropertyName:和propertyName方法。当Runtime在Cache和继承链的所有方法分发列表中都找不到方法时，会调用<code>resolveInstanceMethod:</code>或<code>resolveClassMethod:</code>来给程序员一次动态添加方法实现的机会，需要用<code>class_addMethod</code>函数向某类添加方法实现：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">void</span> <span class="selector-tag">dynamicMethodIMP</span>(id self, SEL _cmd) &#123;</span><br><span class="line">    <span class="comment">// implementation ....</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">@implementation</span> MyClass</span><br><span class="line">+ (BOOL)<span class="attribute">resolveInstanceMethod</span>:(SEL)aSEL &#123;</span><br><span class="line">    <span class="selector-tag">if</span> (aSEL == <span class="variable">@selector</span>(resolveThisMethodDynamically)) &#123;</span><br><span class="line">          <span class="selector-tag">class_addMethod</span>([self class], aSEL, (IMP) dynamicMethodIMP, <span class="string">"v@:"</span>);</span><br><span class="line">          <span class="selector-tag">return</span> <span class="selector-tag">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super resolveInstanceMethod:aSEL]</span>;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure>
<p>上述例子为MyClass添加实例方法resolveThisMethodDynamically，其中 “v@:” 表示返回值和参数，参见<a href="https://developer.apple.com/library/mac/DOCUMENTATION/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="noopener">Type Encoding</a></p>
<p>动态方法解析在消息转发机制之前执行，要让消息进入转发机制，就让<code>resolveInstanceMethod:</code>返回NO</p>
<h4 id="消息转发"><a href="#消息转发" class="headerlink" title="消息转发"></a>消息转发</h4><h5 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h5><p>在消息转发之前，还有一次偷梁换柱的机会，通过重载<code>forwardingTargetForSelector:</code>可以替换消息的接收者：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">-</span> (id)<span class="selector-tag">forwardingTargetForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span> &#123;</span><br><span class="line">    <span class="selector-tag">if</span>(aSelector == <span class="variable">@selector</span>(<span class="attribute">mysteriousMethod</span>:))&#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">alternateObject</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super forwardingTargetForSelector:aSelector]</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="转发"><a href="#转发" class="headerlink" title="转发"></a>转发</h5><p>在对象无法正常响应消息时才会调用<code>forwardInvocation:</code>，重载这个方法来定义任何你想要的转发逻辑：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</span><br><span class="line">    <span class="keyword">if</span> ([someOtherObject <span class="string">respondsToSelector:</span>[anInvocation selector]])</span><br><span class="line">        [anInvocation <span class="string">invokeWithTarget:</span>someOtherObject];</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        [<span class="keyword">super</span> <span class="string">forwardInvocation:</span>anInvocation];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>forwardInvocation:</code>之前，会先调用<code>methodSignatureForSelector:</code>来生成这里的anInvocation参数，所以在重写<code>forwardInvocation:</code>之前还要重写<code>methodSignatureForSelector:</code>，否则会因找不到signature而抛异常</p>
<p>转发可以实现类似多继承的效果，把消息转发给另一个对象，就好像借用或“继承”了另一个对象的方法</p>
<h5 id="替代者对象"><a href="#替代者对象" class="headerlink" title="替代者对象"></a>替代者对象</h5><p>尽管转发能模拟多继承，但<code>respondsToSelector:</code>、<code>isKindOfClass:</code>等方法只会考虑继承链，不会考虑转发链。</p>
<p>如果处于某种意图需要模拟继承，得重载<code>respondsToSelector:</code>、<code>isKindOfClass:</code>、<code>instancesRespondToSelector:</code>来加入转发逻辑：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)respondsToSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">super</span> respondsToSelector:aSelector])</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Here, test whether the aSelector message can     *</span></span><br><span class="line"><span class="comment">         * be forwarded to another object and whether that  *</span></span><br><span class="line"><span class="comment">         * object can respond to it. Return YES if it can.  */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果使用了协议，也得重载<code>conformsToProtocol:</code></p>
<p>同样地，转发还得重载<code>methodSignatureForSelector:</code>，比如一个对象为给它的替代者对象转发消息，需要实现：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (NSMethodSignature*)<span class="string">methodSignatureForSelector:</span>(SEL)selector &#123;</span><br><span class="line">    NSMethodSignature* signature = [<span class="keyword">super</span> <span class="string">methodSignatureForSelector:</span>selector];</span><br><span class="line">    <span class="keyword">if</span> (!signature) &#123;</span><br><span class="line">       signature = [surrogate <span class="string">methodSignatureForSelector:</span>selector];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> signature;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Assiciate-Objects"><a href="#Assiciate-Objects" class="headerlink" title="Assiciate Objects"></a>Assiciate Objects</h3><p>给category添加变量涉及下面三个函数：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">void objc<span class="constructor">_setAssociatedObject(<span class="params">id</span> <span class="params">object</span>, <span class="params">const</span> <span class="params">void</span> <span class="operator">*</span><span class="params">key</span>, <span class="params">id</span> <span class="params">value</span>, <span class="params">objc_AssociationPolicy</span> <span class="params">policy</span>)</span>;</span><br><span class="line">id objc<span class="constructor">_getAssociatedObject(<span class="params">id</span> <span class="params">object</span>, <span class="params">const</span> <span class="params">void</span> <span class="operator">*</span><span class="params">key</span>)</span>;</span><br><span class="line">void objc<span class="constructor">_removeAssociatedObjects(<span class="params">id</span> <span class="params">object</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>其中用来作key的是个内存地址，可直接用某个selector：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NSObject+AssociatedObject.h</span></span><br><span class="line"><span class="variable">@interface</span> NSObject (AssociatedObject)</span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong) id associatedObject;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NSObject+AssociatedObject.m</span></span><br><span class="line"><span class="variable">@implementation</span> NSObject (AssociatedObject)</span><br><span class="line"><span class="variable">@dynamic</span> associatedObject;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">setAssociatedObject</span><span class="selector-pseudo">:(id)object</span> &#123;</span><br><span class="line">     <span class="selector-tag">objc_setAssociatedObject</span>(self, <span class="variable">@selector</span>(associatedObject), object, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">-</span> (id)<span class="selector-tag">associatedObject</span> &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">objc_getAssociatedObject</span>(self, <span class="variable">@selector</span>(associatedObject));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="几个细节"><a href="#几个细节" class="headerlink" title="几个细节"></a>几个细节</h3><h4 id="super-class-self-class"><a href="#super-class-self-class" class="headerlink" title="[super class] == [self class]"></a>[super class] == [self class]</h4><p><code>[self class]</code>会转成</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id objc<span class="constructor">_msgSend(<span class="params">id</span> <span class="params">self</span>, SEL <span class="params">op</span>, <span class="operator">...</span>)</span></span><br></pre></td></tr></table></figure>
<p>向self发消息，从self的方法列表开始，沿继承链向上找@selector(class)的实现。由于没重载过这个方法，最终调用NSObject中的实现。</p>
<p><code>[super class]</code>会转成</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id objc<span class="constructor">_msgSendSuper(<span class="params">struct</span> <span class="params">objc_super</span> <span class="operator">*</span><span class="params">super</span>, SEL <span class="params">op</span>, <span class="operator">...</span>)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_super &#123;</span><br><span class="line">   __<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> receiver;</span><br><span class="line">   __<span class="keyword">unsafe_unretained</span> Class super_class;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中receiver就是self，super_class就是实际超类。同样向self发消息，但从超类的方法列表开始，沿继承链向上找@selector(class)的实现。由于没重载过这个方法，最终调用NSObject中的实现。</p>
<h4 id="Object-amp-Class-amp-MetaClass"><a href="#Object-amp-Class-amp-MetaClass" class="headerlink" title="Object &amp; Class &amp; MetaClass"></a>Object &amp; Class &amp; MetaClass</h4><p><img src="/images/object-class-metaclass.jpg" alt=""></p>
<p>Class也是个对象，Class的类叫MetaClass。有几个特点：</p>
<ul>
<li>MetaClass的superclass继承链，和对应的原本Class的superclass继承链类似；只有根类特殊：NSObject的superclass为nil，MetaClass-of-NSObject的superclass为NSObject</li>
<li>Class的isa指向自己的MetaClass，所有MetaClass的isa指向MetaClass-of-NSObject</li>
</ul>
<h4 id="Category的加载"><a href="#Category的加载" class="headerlink" title="Category的加载"></a>Category的加载</h4><p>Category中的方法在加载时被加入对应的方法列表中：实例方法加入Class的方法列表, 类方法加入MetaClass的方法列表</p>
<p>如果有多个Category，则按加载的逆序把方法加入最终方法列表。比如某类O，按序加载了Category A和B，则最终方法列表是：[B中的方法, A中的方法, O中的方法]</p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/" target="_blank" rel="noopener">Objective-C Runtime</a></li>
<li><a href="http://nshipster.com/associated-objects/" target="_blank" rel="noopener">Associated Objects</a></li>
<li><a href="http://chun.tips/blog/2014/11/05/bao-gen-wen-di-objective[nil]c-runtime%281%29[nil]-self-and-super/" target="_blank" rel="noopener">刨根问底Objective-C Runtime</a></li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/ssl/" itemprop="url">
                SSL笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2014-09-20T00:00:00+08:00" content="2014-09-20">
            2014-09-20
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/ssl/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="ssl/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h3 id="证书颁发机构（CA）-和-客户端的证书验证"><a href="#证书颁发机构（CA）-和-客户端的证书验证" class="headerlink" title="证书颁发机构（CA） 和 客户端的证书验证"></a>证书颁发机构（CA） 和 客户端的证书验证</h3><p>背景：</p>
<ul>
<li>非对称加密：有一对公钥秘钥，公钥加密的数据只能通过密钥解密，密钥加密的数据只能通过公钥解密</li>
<li>客户端含有CA机构的根证书R，根证书R里含：CA机构的公钥pk</li>
<li>服务端含有CA机构颁发的证书A，证书A里含：证书内容F，用CA机构的私钥sk加密F所得的证书加密内容Fs</li>
</ul>
<p>过程：</p>
<p>客户端与服务端建立https连接时，服务端将证书A返回给客户端；客户端用根证书R里的公钥pk去解密证书A里的证书加密内容Fs，若能还原得F则证书验证通过。</p>
<p>整个流程大致是：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">|<span class="type">--- CA</span>机构 ---|<span class="type">--- 客户端 ---|</span></span><br><span class="line"><span class="type">F</span>-&gt;CA私钥加密-&gt;Fs-&gt;CA公钥解密-&gt;F</span><br></pre></td></tr></table></figure>

<h3 id="SSL-Pinning"><a href="#SSL-Pinning" class="headerlink" title="SSL Pinning"></a>SSL Pinning</h3><p>客户端直接保存服务端的证书，建立https连接时客户端直接对比服务端返回的和自己保存的两个证书是否一致</p>
<p>不需要CA机构了（CA机构颁发证书较贵），可以自己颁发证书</p>
<p>适用于非浏览器应用，比如CS架构的app。因为浏览器跟很多未知服务器打交道，无法保存每个服务器的证书</p>
<p>中间人虽然可以从客户端取出证书伪装成服务器并通过证书验证，但后续的数据通讯客户端会用证书中的公钥加密，中间人没有私钥无法解密</p>
<h3 id="SSL的握手过程"><a href="#SSL的握手过程" class="headerlink" title="SSL的握手过程"></a>SSL的握手过程</h3><p><a href="https://blog.cloudflare.com/content/images/2014/Sep/ssl_handshake_rsa.jpg" target="blank"><img src="https://blog.cloudflare.com/content/images/2014/Sep/ssl_handshake_rsa.jpg" width="600px" /></a></p>
<ul>
<li><p>客户端和服务端一共同步三个随机数以生成最后的session key。前两个随机数client random和server random明文传输，第三个随机数pre-master key用服务器的公密钥加解密（非对称加密）</p>
</li>
<li><p>握手完成后的通信是普通的http协议，只是都用session key加解密（对称加密）</p>
</li>
<li><p>服务器公钥是放在数字证书中传给客户端的，这是为了保证公钥不被篡改。只要证书是可信的，公钥就是可信的</p>
</li>
</ul>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://blog.cnbang.net/tech/2416/" target="_blank" rel="noopener">AFNetworking源码解析&lt;三&gt;
</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html" target="_blank" rel="noopener">图解SSL/TLS协议</a></li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/objc/" itemprop="url">
                ObjectiveC笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2014-05-04T00:00:00+08:00" content="2014-05-04">
            2014-05-04
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/objc/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="objc/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h3 id="block"><a href="#block" class="headerlink" title="block"></a>block</h3><ul>
<li><p>block分stack/heap/global：block通常是其创建时所在作用域的栈变量，出了作用域这块内存可能被释放可能不释放；通过copy后block变成堆变量，使用引用计数；未引用任何外部变量和参数的block是全局变量，copy无用也不dealloc。    </p>
</li>
<li><p>block的参数列表为空时是接受_可变参数_，<code>void (^block)();</code>和<code>void (^block)(void);</code>不同。</p>
<p>  参见：<a href="http://blog.sunnyxx.com/2014/08/02/objc-weird-code/" target="_blank" rel="noopener">ObjC非主流代码技巧</a></p>
</li>
<li><p>block中避免循环引用self：先在block外：</p>
  <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br></pre></td></tr></table></figure>
<p>  然后在block中:</p>
  <figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">__strong</span> __typeof(weakSelf) strongSelf = weakSelf;</span><br></pre></td></tr></table></figure>
<p>  注意：block中的_ivar会隐式引用self（即self-&gt;_ivar），要改成weakSelf-&gt;_ivar或weakSelf.ivar。更优雅的方法是使用ReactiveCocoa的<a href="https://github.com/jspahrsummers/libextobjc" target="_blank" rel="noopener">libextobjc</a>中的<code>@weakify(self)</code>和<code>@strongify(self)</code>。</p>
</li>
<li><p>在block中要小心使用<code>NSAssert</code>，因为NSAssert宏展开中使用了self很可能导致循环引用，可用<code>NSCassert</code>。</p>
</li>
</ul>
<h3 id="selector"><a href="#selector" class="headerlink" title="selector"></a>selector</h3><ul>
<li><p>performSelector延迟调用可用<code>dispatch_after()</code>替代，如：</p>
  <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [self performSelector:@selector(doSomething) withObject:nil afterDelay:5.0];</span></span><br><span class="line">dispatch_time time = dispatch<span class="constructor">_time(DISPATCH_TIME_NOW, (<span class="params">int64_t</span>)</span>(<span class="number">5.0</span><span class="operator"> * </span>NSEC_PER_SEC));</span><br><span class="line">dispatch<span class="constructor">_after(<span class="params">time</span>, <span class="params">dispatch_get_main_queue</span>()</span>, ^(void)&#123;</span><br><span class="line">    <span class="literal">[<span class="identifier">self</span> <span class="identifier">doSomething</span>]</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>performSelector调用的方法至多接收两个id参数，要调用其他签名形式的方法可使用<code>NSInvocation</code>实现。比如，为调用类似<code>- (void)drawPoint:(CGPoint)point;</code>形式的方法，可写工具类：</p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)<span class="string">performSelector:</span>(SEL)selector <span class="string">atTarget:</span>(id)target <span class="string">withArgument:</span>(<span class="keyword">void</span> *)argument &#123;</span><br><span class="line">    NSMethodSignature *signature = [target <span class="string">methodSignatureForSelector:</span>selector];</span><br><span class="line">    NSInvocation *invocation = [NSInvocation <span class="string">invocationWithMethodSignature:</span>signature];</span><br><span class="line">    invocation.target = target;</span><br><span class="line">    invocation.selector = selector;</span><br><span class="line">    [invocation <span class="string">setArgument:</span>argument <span class="string">atIndex:</span><span class="number">2</span>];</span><br><span class="line">    [invocation invoke];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  参见：<a href="http://greenchiu.github.io/blog/2013/04/27/yong-nsinvocationlai-qu-dai-performselector/" target="_blank" rel="noopener">NSInvocation更详细用法</a></p>
</li>
<li><p>当object收到未知消息时会调用<code>- (void)forwardInvocation:(NSInvocation *)anInvocation</code>，因此有机会转发消息。</p>
<p>  参见：<a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtForwarding.html" target="_blank" rel="noopener">Message Forwarding</a></p>
</li>
</ul>
<h3 id="预处理指令"><a href="#预处理指令" class="headerlink" title="预处理指令"></a>预处理指令</h3><ul>
<li><p>为确保文件被引用时开启ARC，添加</p>
  <figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#if ! __has_feature(objc_arc)</span></span><br><span class="line"><span class="meta">#error This class is ARC only. Either turn on ARC for the project or use -fobjc-arc flag</span></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>用<code>#pragma</code>supress warning：</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic ignored <span class="meta-string">"-Wxxx"</span></span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic pop</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>category中方法重载的warning：-Wobjc-protocol-method-implementation</p>
</li>
<li><p>调用deprecated方法的warning：-Wdeprecated-declarations</p>
<p>pragma的其他用法见<a href="http://raptureinvenice.com/pragmas-arent-just-for-marks/" target="_blank" rel="noopener">Pragmas Aren’t Just For Marks</a></p>
</li>
</ul>
</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li><p>在category中使用<a href="https://github.com/rentzsch/jrswizzle" target="_blank" rel="noopener">Method Swizzle</a>，要在+load()中swizzle，在+initialize()中调用会因category的initialize()和原类中被重载的initialize()的两次调用互相抵消。</p>
</li>
<li><p><a href="http://philjordan.eu/article/mixing-objective-c-c++-and-objective-c++" target="_blank" rel="noopener">混用ObjectiveC和C++</a></p>
</li>
<li><p>NSMutableArray的底层实现<code>__NSArrayM</code>是个循环数组，所以在首尾两端插入删除无需移动元素，最坏情况在中间插入删除要移动n/2个元素。插入元素时若空间不足，则空间按1.625倍增长，空间增长后即使删除元素空间也不再变小。见<a href="http://ciechanowski.me/blog/2014/03/05/exposing-nsmutablearray/" target="_blank" rel="noopener">Exposing NSMutableArray</a></p>
</li>
<li><p>给类添加类似array的index存取功能，实现</p>
  <figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(id)</span>objectAtIndexedSubscript:<span class="params">(NSUInteger)</span>idx;</span><br><span class="line">- <span class="params">(void)</span>setObject:<span class="params">(id)</span>obj atIndexedSubscript:<span class="params">(NSUInteger)</span>idx;</span><br></pre></td></tr></table></figure>

<p>  添加类似dict的key存取功能，实现</p>
  <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)objectAtKeyedSubscript:(<span class="keyword">id</span> &lt;<span class="built_in">NSCopying</span>&gt;)key;</span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">id</span>)obj forKeyedSubscript:(<span class="keyword">id</span> &lt;<span class="built_in">NSCopying</span>&gt;)key;</span><br></pre></td></tr></table></figure>
</li>
<li><p>release build中去掉NSLog，在<code>Prefix.pch</code>中添加:</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NDEBUG</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> NSLog(...) <span class="comment">/* suppress NSLog for release mode */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>non-retaining array/set for delegates:</p>
  <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFArrayCallBacks</span> callbacks = &#123; <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="built_in">CFCopyDescription</span>, <span class="built_in">CFEqual</span> &#125;;</span><br><span class="line"><span class="built_in">NSMutableArray</span> *noRetainArray = (<span class="built_in">NSMutableArray</span> *)<span class="built_in">CFArrayCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, &amp;callbacks);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableSet</span> *noRetainSet = (<span class="built_in">NSMutableSet</span> *)<span class="built_in">CFSetCreateMutable</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>倒序数组：</p>
  <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">array</span><span class="selector-class">.reverseObjectEnumerator</span><span class="selector-class">.allObjects</span>`</span><br></pre></td></tr></table></figure>
</li>
<li><p>快速遍历含不同类型x值的集合：</p>
  <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span>&lt;<span class="built_in">NSFastEnumeration</span>&gt; collection = values;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> collection) &#123; … &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>作为dict键值的object要遵循<code>&lt;NSCopying&gt;</code>，如果不遵循又要做键值，使用</p>
  <figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NSValue valueWithNonretainedObject:<span class="keyword">object</span>]]</span><br></pre></td></tr></table></figure></li>
<li><p>使用block遍历collection：</p>
  <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Array</span></span><br><span class="line"><span class="built_in">NSArray</span> *array = <span class="comment">/* ... */</span>;</span><br><span class="line">[array enumerateObjectsUsingBlock:^(<span class="keyword">id</span> object, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// Dictioinary</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *dict = <span class="comment">/* ... */</span>;</span><br><span class="line">[dict enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *key, <span class="built_in">NSString</span> *obj, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">&#125;];    </span><br><span class="line"><span class="comment">// Set</span></span><br><span class="line"><span class="built_in">NSSet</span> *set = <span class="comment">/* ... */</span>;</span><br><span class="line">[set enumerateObjectsUsingBlock:^(<span class="keyword">id</span> object, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>  此外还有带options的版本，如：<code>enumerateObjectsWithOptions:usingBlock:</code>。</p>
<p>  通过options可指定是否并行迭代<code>NSEnumerationConcurrent</code>，是否反向迭代<code>NSEnumerationReverse</code>。</p>
</li>
<li><p>使用NSURL.h、NSPathUtilities.h、<code>NSURLComponents</code>操作url</p>
</li>
<li><p>使用<code>NSByteCountFormatter</code>美化下载字节计数：<code>[formatter stringFromByteCount:byteCount]</code></p>
</li>
<li><p>只在某.m中使用的常量：</p>
  <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .m</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">NSString</span> *kStringConstant = <span class="string">@"VALUE"</span>;`</span><br></pre></td></tr></table></figure>
<p>  全局常量：</p>
  <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="keyword">extern</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> EOCStringConstant;</span><br><span class="line"><span class="comment">// .m</span></span><br><span class="line"><span class="built_in">NSString</span> *<span class="keyword">const</span> EOCStringConstant = <span class="string">@"VALUE"</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用宏<code>NS_ENUM</code>和<code>NS_OPTIONS</code>来定义指定类型的枚举</p>
</li>
<li><p>使用NSCache而不是NSDictionary来cache，可在系统内存不足时自动清理</p>
</li>
<li><p>switch语句处理枚举值时不要实现default语句，这样当添加新的枚举值后，编译器会警告你没有处理完所有枚举值</p>
</li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/python/" itemprop="url">
                Python笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2013-09-09T00:00:00+08:00" content="2013-09-09">
            2013-09-09
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/python/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="python/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>python中的<code>yield</code>将function变成generator（一种iterator），用于多次调用生成一系列值（一次调用生成系列值中的一个）。<code>yield</code>作用类似于<code>return</code>，但只是放弃（yield）执行权，函数内部状态（变量和执行情况）保持不变。</p>
<p>参考：<a href="http://www.jeffknupp.com/blog/2013/04/07/improve-your-python-yield-and-generators-explained/" target="_blank" rel="noopener">‘yield’ and Generators Explained</a></p>
<p>注：ruby中的<code>yield</code>类似拉环，拉出函数附带的block来执行。</p>
<hr>
<p>若在.sh文件里执行python脚本报<code>ImportError</code>错，而在shell里直接执行没问题，要设置在.sh里export PYTHONPATH，如：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">PYTHONPATH</span>=/usr/local/lib/python2.7/site-packages:$PYTHONPATH</span><br></pre></td></tr></table></figure>

<h2 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a>Unicode</h2><p>用<code>type()</code>查看变量是’unicode‘还是’str’，<code>unicode(str, &#39;utf-8&#39;)</code>返回str的utf-8表示</p>
<p>注音字母的Unicode有两种<a href="http://en.wikipedia.org/wiki/Unicode_equivalence" target="_blank" rel="noopener">等价形式</a>：</p>
<ul>
<li>标着注音的字母（即composed形式）: 又分canonical的<code>NFC</code>和compatable的<code>NFKC</code></li>
<li>字母和注音（即decomposed形式）: 又分canonical的<code>NFD</code>和compatable的<code>NFKD</code></li>
</ul>
<p>用<code>unicodedata</code>库来normalize</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> unicodedata</span><br><span class="line"> </span><br><span class="line">data = <span class="string">u'naïve café'</span></span><br><span class="line">normal = unicodedata.normalize(<span class="string">'NFKD'</span>, data).encode(<span class="string">'ASCII'</span>, <span class="string">'ignore'</span>)</span><br><span class="line"><span class="keyword">print</span> normal</span><br><span class="line"> </span><br><span class="line"><span class="comment"># prints "naive cafe"</span></span><br></pre></td></tr></table></figure>

<h2 id="scrapy"><a href="#scrapy" class="headerlink" title="scrapy"></a>scrapy</h2><ul>
<li><p><a href="http://philipcodings.com/post/recursively-crawling-a-website-with-python-and-scrapy" target="_blank" rel="noopener">recursively crawling a website with Python and Scrapy</a></p>
</li>
<li><p>页面解析用<a href="https://github.com/gawel/pyquery" target="_blank" rel="noopener">pyquery</a>（内部使用lxml）</p>
</li>
<li><p>解析js：</p>
  <figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">from</span> <span class="keyword">selenium </span><span class="meta">import</span> webdriver</span><br><span class="line"><span class="keyword">browser </span>= webdriver.PhantomJS()</span><br><span class="line"><span class="keyword">browser.get(url)</span></span><br><span class="line"><span class="keyword">print </span><span class="keyword">browser.page_source</span></span><br><span class="line"><span class="keyword">browser.quit</span></span><br></pre></td></tr></table></figure></li>
<li><p>downloader下载url，spider解析Item，pipeline对Item做后续处理</p>
</li>
</ul>
<h2 id="twisted"><a href="#twisted" class="headerlink" title="twisted"></a>twisted</h2><ul>
<li><a href="http://krondo.com/blog/?page_id=1327" target="_blank" rel="noopener">Dave的Twisted入门</a>（<a href="http://blog.sina.com.cn/s/blog_704b6af70100py9n.html" target="_blank" rel="noopener">中文翻译</a>）</li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/ios/" itemprop="url">
                iOS杂记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2013-08-14T00:00:00+08:00" content="2013-08-14">
            2013-08-14
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/ios/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="ios/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><ul>
<li><p>ios抓包用<a href="http://blog.devtang.com/blog/2013/12/11/network-tool-charles-intr/" target="_blank" rel="noopener">charles</a></p>
</li>
<li><p>监听iPhone上的https请求，要先在iPhone上用Safari访问<a href="http://www.charlesproxy.com/charles.crt" target="_blank" rel="noopener">安装证书</a></p>
</li>
<li><p>Error Messages should be of <a href="http://inessential.com/2014/05/05/error_messages" target="_blank" rel="noopener">the form</a>:</p>
<pre><code>[Noun] Can&apos;t x because y. [Something is true. Try a thing.]</code></pre></li>
</ul>
<h3 id="CocoaPods"><a href="#CocoaPods" class="headerlink" title="CocoaPods"></a>CocoaPods</h3><ul>
<li><p>安装：<code>sudo gem install cocoapods</code></p>
</li>
<li><p>使用：在项目目录下建个<code>Podfile</code>，内容如 </p>
<pre><code>platform :ios, &apos;7.0&apos;
inhibit_all_warnings! #禁止pods里的warnings
pod &apos;Reachability&apos;,  &apos;~&gt; 3.1.1&apos;</code></pre><p>  然后<code>pod install</code>，打开生成的<code>.xcworkspace</code>来使用</p>
<p>  参考：<a href="http://blog.devtang.com/blog/2014/05/25/use-cocoapod-to-manage-ios-lib-dependency/" target="_blank" rel="noopener">管理包依赖</a>、<a href="http://www.iwangke.me/2013/04/18/advanced-cocoapods/" target="_blank" rel="noopener">管理本地包</a>、<a href="http://docs.cocoapods.org/podfile.html#pod" target="_blank" rel="noopener">Podfile格式</a> </p>
</li>
</ul>
<h3 id="静态库"><a href="#静态库" class="headerlink" title="静态库"></a>静态库</h3><ul>
<li><p>创建静态库，<a href="http://www.raywenderlich.com/41377/creating-a-status-library-in-ios-tutorial" target="_blank" rel="noopener">参见tutorial</a></p>
<ul>
<li>若静态库中用到c++而父项目中没用到，则要在父项目的<code>Other Linker Flags</code>中添加<code>-lc++</code>(静态库使用<code>libc++</code>)或<code>-lstdc++</code>(静态库使用<code>libstdc++</code>)，<a href="http://stackoverflow.com/a/16257773/1263403" target="_blank" rel="noopener">参见StackOverflow</a></li>
<li>静态库只是<code>.o</code>文件的集合，用到的framework都得在父项目中重新link一遍</li>
</ul>
</li>
<li><p>将静态库的<code>SL.xcodeproj</code>拖进父项目作为子项目的步骤：</p>
<ol>
<li><p>父项目的<code>Target Depedencies</code>和<code>Link Binary With Libraries</code>中添加<code>libSL.a</code></p>
</li>
<li><p>父项目的<code>Other Linker Flags</code>中添加<code>-ObjC</code></p>
<blockquote>
<p><code>-ObjC</code> causes the linker to load every object file in the library that defines an Objective-C class or category. While this option will typically result in a larger executable (due to additional object code loaded into the application), it will allow the successful creation of effective Objective-C static libraries that contain categories on existing classes.<br>参见<a href="https://developer.apple.com/library/mac/qa/qa1490/_index.html" target="_blank" rel="noopener">QA1490</a></p>
</blockquote>
</li>
<li><p>父项目的<code>Header Search Paths</code>中添加静态库头文件所在的目录，记得选中<code>recursive</code></p>
</li>
<li><p>父项目的<code>Link Binary With Libraries</code>中添加子项目用到的库</p>
<p>参见：<a href="http://www.cocoanetics.com/2011/12/sub-projects-in-xcode/" target="_blank" rel="noopener">Sub-Projects in Xcode</a></p>
</li>
</ol>
</li>
<li><p>ios上的framework只是对静态库及头文件的封装，动态库因security问题在appstore上被禁使用，所以ios上的framework就是static framework</p>
<ul>
<li><a href="https://github.com/jverkoey/iOS-Framework" target="_blank" rel="noopener">将静态库手动改成framework</a></li>
<li><a href="https://github.com/kstenerud/iOS-Universal-Framework" target="_blank" rel="noopener">从Xcode模板创建framework</a></li>
</ul>
</li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/">&amp;laquo;</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">&amp;raquo;</a>
  </nav>

 </div>

        

        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.png" alt="Yang Le" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Yang Le</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">47</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">13</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="menu-item-icon icon-next-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yang Le</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io" target="_blank" rel="noopener">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"smilingpoplar"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
